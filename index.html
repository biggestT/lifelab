
<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
<link href="treemap.css" rel="stylesheet" type="text/css">
<script type="text/javascript">
	$(function() { 
		
		
	$.getJSON('week1Simple.json', function( log ) {
		
		Category = function (name) {
			this.name = name;
			this.dur = 0;
		}

			var categories = new Array();
			var totalDur = 0;
			// tm = new TreeMap('#lab1');

			dtm = new DOMTreeMap('#treemap');

	  $.each(log, function(key, entry) {
	  	// convert duration from hh:mm to decimal hours float value
	  	var durS = entry.Duration;
	  	durS = durS.replace(":", "");
	  	var l = durS.length;
	  	var dur = parseFloat(durS.substr(0, l-2))/2.4 + parseFloat(durS.substr(l-2, l))/144;
	  	var name = entry.Task;
	  	

			var thisCategory = $.grep(categories, function (item) {
				return (item.name == name);
			})[0];
	  	if ( !thisCategory ) {
	  			thisCategory = new Category(name)
	  			categories.push(thisCategory);
	  	};
	  	thisCategory.dur += dur;
	  	totalDur += dur;
	  });
	  console.log(totalDur);
	  // tm.draw(categories);
	  dtm.createAreas(categories, totalDur);
	  dtm.sortAreas(categories, totalDur);
	  dtm.squarification();
	  // dtm.draw();


	});

	DOMTreeMap = function (id) {
		this.$el = $(id);
		console.log(this.$el[0]);
		this.width = this.$el.width();
		this.height = this.$el.height();
		this._size = this.width*this.height;

		// $(window).resize(function() {
	 //    this.height = this.$el.height();
	 //    this.width = this.$el.width();
	 //    // this.draw();

	 //  }.bind(this));

		// Initialize free subrectangle to cover the whole div
		this._free = [];
		this._free.width = this.width;
		this._free.height = this.height;
		this._free.top = 0;
		this._free.left = 0;
		console.log(this._free);
	}

	var Area = function (a, n, i) {
		this.area = a;
		this.name = n;
		this.index = i;
	}


	DOMTreeMap.prototype.createAreas = function (data, total) {
			
		var areas = [];
		var tot = 0;
		for (var i = data.length - 1; i >= 0; i--) {
			var currArea = (data[i].dur / total) * this._size;
			areas[i] = new Area(currArea, data[i].name, i);
			console.log(currArea);
		};

		this._areas = areas;
		// this._tot
	}
	DOMTreeMap.prototype.sortAreas = function () {
		this._areas.sort( function (a, b) {
			return b.area - a.area;
		});
	}

	DOMTreeMap.prototype.createTimeBlock = function (name, index, x, y, w, h) {
		console.log(this._areas.length);
		var shade = index/this._areas.length*200;
		var color = "rgb(" + shade + "," + (shade) + "," + (shade+100) + ")";

		var block = $('<div>', { 
			class: 'timeblock'
		});
		block.css({
			'background-color': color,
			'position': 'absolute',
			'width': w + 'px',
			'height': h + 'px',
			'top': y,
			'left': x,
			'display': 'block',
			'text-align': 'center'
		});

		var fontSize = Math.max(w/this.width * 10, 1);
		var txtElement = $('<p>');
		txtElement.css({
			'font-size': fontSize + 'vw'
		})
		txtElement.text(name);

		block.append(txtElement);
		return block;
	};

	DOMTreeMap.prototype.addRow = function (row, tot) {

		var widthSmallest = (this._free.width <= this._free.height) ? true : false;
		var heightSmallest = !widthSmallest;

		var xStart = this._free.left;
		var yStart = this._free.top;
		var freeArea = this._free.width * this._free.height;

		var blocks = [];

		var width, height;
		
		for (var i = 0; i < row.length; i++) {
			if (heightSmallest) {
				width = tot / freeArea * this._free.width;
				height = row[i].area / tot * this._free.height;
			}
			else {
				height = tot / freeArea * this._free.height;
				width = row[i].area / tot * this._free.width;
			}
			var $block = this.createTimeBlock(row[i].name, row[i].index, xStart, yStart, width, height);
			xStart += (heightSmallest) ? 0 : width;
			yStart += (widthSmallest) ? 0 : height;

			blocks.push($block);
		};
		console.log(blocks);

		this.$el.prepend(blocks);

		this._free.left = (heightSmallest) ? this._free.left + width : this._free.left;
		this._free.top = (widthSmallest) ? this._free.top + height : this._free.top;
		this._free.width = (heightSmallest) ? this.width - this._free.left : this._free.width;
		this._free.height = (widthSmallest) ? this.height - this._free.top : this._free.height;
		console.log('free space after addition: ' + this._free.width  + ' ' + this._free.height);
		console.log(' xStart: ' + xStart + ' yStart: ' + yStart);
	};

	// Implementation of subdivision algorithm explained in:
	// http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.36.6685&rep=rep1&type=pdf

	DOMTreeMap.prototype.squarification = function () {

		// var tot = this._totDur;
		// var areaList = this._categories;
		var map = this;

		var worstAspectRatio = function (tot, areas, w) {
			// areas.sort(function (a, b) {
			// 	return b.area - a.area;
			// });
			if(areas.length === 0) {
				console.log('outputting min aspect ratio: ' + Number.MAX_VALUE);
				return Number.MAX_VALUE;
			}
			var maxArea = (areas.length !== 0) ? areas[0].area : 0;
			var minArea = (areas.length > 1) ? areas[areas.length-1].area : maxArea;
			
			var aspect1 = (w*w*maxArea)/(tot*tot);
			var aspect2 = (tot*tot)/(w*w*minArea);
			var max = Math.max(aspect1, aspect2 );
			console.log('max: ' + maxArea + 'min: ' + minArea);
			console.log('aspect1: '+ aspect1 + ' aspect2: ' + aspect2);
			console.log('worst aspect: '+ max);
			return max;
		};

		var width = function () {
			var min = Math.min(map._free.width, map._free.height);
			// console.log(min);
			return min;
		}
		// var Row = function (row) {
		// 	this._area = row
		// }
		squarify = function (areas, row, w) {


			var curr = areas[0];
			// var newRow = jQuery.extend(true, {}, row);
			var newRow = row.slice(0);
			newRow.push(curr);

			var oldTotArea = 0;
			for (var i = 0; i < row.length; i++) {
				oldTotArea += row[i].area;
			};
			// oldTotArea -= curr.area;
			if (areas.length === 0 ) { 
				map.addRow(row, oldTotArea);
				return; 
			}

			var newTotArea = oldTotArea;
			newTotArea += curr.area;

			console.log('old row: '+ JSON.stringify(row) + 'area: ' + oldTotArea);
			console.log('new row: '+ JSON.stringify(newRow) + 'area: ' + newTotArea);
			console.log('w  '+ w);

			console.log('calculating old row worst aspect \n -----------');
			var oldRowWorst = worstAspectRatio(oldTotArea, row, w);
			console.log('calculating new row worst aspect \n  -----------');
			var newRowWorst = worstAspectRatio(newTotArea, newRow, w);

			if (  oldRowWorst <= newRowWorst  ) {
				console.log(' %c laying out row',  'color: red;');
				map.addRow(row, oldTotArea);
				squarify( areas, [], width());
			}
			else {
				console.log(' %c adding more on same row', 'color: blue;');
				areas.shift(); 
				squarify(areas, newRow, w);
			}
		};
		var areasCopy = this._areas.slice(0);
		console.log(areasCopy);
		squarify(areasCopy, [], width());
	};

	DOMTreeMap.prototype.draw = function () {
		this.$el.empty();	

		this.blocks = [];
		var c = this._categories;

		for (var i = 0; i < c.length; i++) {
			var block = this.createTimeBlock(c[i].name, i, i*100, 0, 20, 80);
			this.blocks.push(block);

		}

		this.$el.prepend(this.blocks);

	}


	TreeMap = function(cId) {
	  var canvas = $(cId)[0];

	  $(window).resize(function() {
	    canvas.height = $(cId).height();
	    canvas.width = $(cId).width();
	  });
	  $(window).trigger('resize');
	  
	  this.ctx = canvas.getContext('2d'); 
	};

	TreeMap.prototype.draw = function(categories) {
		var ctx = this.ctx;
		var c = this.ctx.canvas;
		var currentHor = 0;

		for (var i = 0; i < categories.length; i++) {
			var shade = i/categories.length*200;
			var relSize = categories[i].dur/70;
			ctx.fillStyle = "rgb(" + shade + "," + (shade) + "," + (shade+100) + ")";
			ctx.fillRect(currentHor,0,relSize*c.width,c.height);

			ctx.save();
				ctx.translate(currentHor,10);
				ctx.rotate(Math.PI/2);
				ctx.fillStyle = "rgb(255,255,255)";
				ctx.font = "10px sans-serif";
				ctx.fillText(categories[i].name, 0, 0);
			ctx.restore();
			
			currentHor +=	 relSize*c.width;
		};


	}
});	

</script>

<div id="treemap" style="
    width: 100%;
    height: 100%;">
</div>
<!-- <canvas id="lab1"  width="1000" height="300" ></canvas> -->
<div id="title">CAPTURE THE WEEK 2013</div>